#!/usr/bin/env ruby

require 'optparse'
require 'net/smtp'
require 'mail'
require 'logger'
require 'yaml'
require 'fault_tolerant_router/version'
require 'fault_tolerant_router/generate_config'
require 'fault_tolerant_router/generate_iptables'
require 'fault_tolerant_router/monitor'

options = {
    config: '/etc/fault_tolerant_router.conf',
    debug: false,
    demo: false
}
parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename($0)} [OPTION]... ACTION"
  opts.separator ''
  opts.separator 'ACTION = generate_config|generate_iptables|test_email|monitor'
  opts.separator ''
  opts.separator '         generate_config: print an example configuration'
  opts.separator '         generate_iptables: generate an iptables iptables-save configuration'
  opts.separator '         test_email: send a test email to test the correctness of smtp parameters'
  opts.separator '         monitor: monitor uplinks and change routing accordingly'
  opts.separator ''
  opts.separator 'option valid for all the actions except "generate_config":'
  opts.on('--config=FILE', 'Configuration file (default /etc/fault_tolerant_router.conf)') do |configuration_file|
    options[:config] = configuration_file
  end
  opts.separator ''
  opts.separator '"monitor" specific options:'
  opts.on('--debug', 'Print debug output') do |debug|
    options[:debug] = debug
  end
  opts.on('--demo', 'Demo the program by faking random uplink failures') do |demo|
    options[:demo] = demo
  end
  opts.separator ''
  opts.separator "Version #{FaultTolerantRouter::VERSION} - Alessandro Zarrilli <alessandro@zarrilli.net>"
end
begin
  parser.parse!
rescue OptionParser::ParseError
  puts parser.help
  exit 1
end

DEMO = options[:demo]
#activate debug if we are in demo mode
DEBUG = options[:debug] || DEMO

unless ARGV.size == 1 && %w(generate_config generate_iptables test_email monitor).include?(ARGV[0])
  puts parser.help
  exit 1
end

if ARGV[0] == 'generate_config'
  generate_config
  exit 0
end

unless File.exists?(options[:config])
  puts "Configuration file #{options[:config]} does not exists!"
  exit 1
end

config = YAML.load_file(options[:config])
UPLINKS = config['uplinks'].map { |uplink| Hash[uplink.map { |k, v| [k.to_sym, v] }] }
LAN_INTERFACE = config['downlinks']['lan']
DMZ_INTERFACE = config['downlinks']['dmz']
TEST_IPS = config['tests']['ips']
REQUIRED_SUCCESSFUL_TESTS = config['tests']['required_successful']
PING_RETRIES = config['tests']['ping_retries']
TEST_INTERVAL = config['tests']['interval']
LOG_FILE = config['log']['log_file']
LOG_MAX_SIZE = config['log']['max_size']
LOG_OLD_FILES = config['log']['old_files']
SEND_EMAIL = config['email']['send']
EMAIL_SENDER = config['email']['sender']
EMAIL_RECIPIENTS = config['email']['recipients']
SMTP_PARAMETERS = Hash[config['email']['smtp_parameters'].map { |k, v| [k.to_sym, v] }]
BASE_TABLE = config['base_table']
BASE_PRIORITY = config['base_priority']
BASE_FWMARK = config['base_fwmark']

case ARGV[0]
  when 'generate_iptables'
    generate_iptables
  when 'test_email'
    begin
      send_email('fault_tolerant_router test')
      puts 'email sent'
    rescue Exception => e
      puts "Problem sending email: #{e}"
    end
  else
    monitor
end
